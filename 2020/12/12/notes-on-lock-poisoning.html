
<!DOCTYPE html>
<html lang='en-US'>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Notes On Lock Poisoning</title>
  <meta name="description" content="Rust's libs teams is considering overhauling std::sync module.
As a part of this effort, they are launching lock poisoning survey.">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="canonical" href="https://matklad.github.io/2020/12/12/notes-on-lock-poisoning.html">
  <link rel="alternate" type="application/rss+xml" title="matklad" href="https://matklad.github.io/feed.xml">
  <style>
  @font-face {
    font-family: 'Open Sans'; src: url('/css/OpenSans-300-Normal.woff2') format('woff2');
    font-weight: 300; font-style: normal;
  }
  @font-face {
    font-family: 'JetBrains Mono'; src: url('/css/JetBrainsMono-400-Normal.woff2') format('woff2');
    font-weight: 400; font-style: normal;
  }
  @font-face {
    font-family: 'JetBrains Mono'; src: url('/css/JetBrainsMono-700-Normal.woff2') format('woff2');
    font-weight: 700; font-style: normal;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-400-Normal.woff2') format('woff2');
    font-weight: 400; font-style: normal;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-400-Italic.woff2') format('woff2');
    font-weight: 400; font-style: italic;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-700-Normal.woff2') format('woff2');
    font-weight: 700; font-style: normal;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-700-Italic.woff2') format('woff2');
    font-weight: 700; font-style: italic;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; margin-block-start: 0; margin-block-end: 0; }

  body {
    max-width: 80ch;
    padding: 2ch;
    margin-left: auto;
    margin-right: auto;
  }

  header { margin-bottom: 2rem; }
  header > nav { display: flex; column-gap: 2ch; align-items: baseline; flex-wrap: wrap; }
  header a { font-style: normal; color: rgba(0, 0, 0, .8); text-decoration: none; }
  header a:hover { color: rgba(0, 0, 0, .8); text-decoration: underline; }
  header .title { font-size: 1.25em; flex-grow: 2; }

  footer { margin-top: 2rem; }
  footer > p { display: flex; column-gap: 2ch; justify-content: center; flex-wrap: wrap; }
  footer a { color: rgba(0, 0, 0, .8); text-decoration: none; white-space: nowrap; }
  footer i { vertical-align: middle; color: rgba(0, 0, 0, .8) }

  </style>

  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
  <header>
    <nav>
      <a class="title" href="/">matklad</a>
      <a href="/about.html">About</a>
      <a href="/resume.html">Resume</a>
      <a href="/links.html">Links</a>
    </nav>
  </header>

  <main>
  <article >

    <h1>
    <a href="#Notes-On-Lock-Poisoning">Notes On Lock Poisoning <time datetime="2020-12-12">Dec 12, 2020</time></a>
    </h1>
<p>Rust&rsquo;s libs teams is considering overhauling <code>std::sync</code> module.
As a part of this effort, they are launching lock poisoning survey.</p>
<p><a href="https://blog.rust-lang.org/2020/12/11/lock-poisoning-survey.html" class="url">https://blog.rust-lang.org/2020/12/11/lock-poisoning-survey.html</a></p>
<p>This is post is a an extended response to that survey.
It is not be well-edited :-)</p>
<section id="Panics-Should-Propagate">

    <h2>
    <a href="#Panics-Should-Propagate">Panics Should Propagate </a>
    </h2>
<p>Midori error model makes sharp distinction between two kinds of errors:</p>
<ul>
<li>
bugs in the program, like indexing an array with <code>-92</code>
</li>
<li>
error conditions in programs&rsquo; environment (reading a file which doesn&rsquo;t exist)
</li>
</ul>
<p>In Rust, those correspond to panics and Results.
It&rsquo;s important to not mix the two.</p>
<p>std I think sadly does mix them in sync API.
The following APIs convert panics to recoverable results:</p>
<ul>
<li>
<code>Mutex::lock</code>
</li>
<li>
<code>thread::JoinHandle::join</code>
</li>
<li>
<code>mpsc::Sender::send</code>
</li>
</ul>
<p>All those APIs return a <code>Result</code> when the other thread panicked.
These leads to people using <code>?</code> with these methods, using recoverable error handling for bugs in the program.</p>
<p>In my mind, a better design would be to make those API <code>panic</code> by default.
Sometimes synchronization point also happen to be failure isolation boundaries.
More verbose result-returning <code>catching_lock</code>, <code>catching_join</code>, <code>catching_send</code> would work for those special cases.</p>
<p>If <code>std::Mutex</code> did implement lock poisoning, but the <code>lock</code> method returned a <code>LockGuard&lt;T&gt;</code>, rather than <code>Result&lt;LockGuard&lt;T&gt;, PoisonError&gt;</code>, then we wouldn&rsquo;t be discussing poisoning in the rust book, in every mutex example, and wouldn&rsquo;t consider changing the status quo.
At the same time, we&rsquo;d preserve &ldquo;safer&rdquo; semantics of lock poisoning.</p>
<p>There&rsquo;s an additional consideration here.
In a single-threaded program, panic propagation is linear.
One panic is unwound past a sequence of frames.
If we get the second panic in some <code>Drop</code>, the result is process aborting.</p>
<p>In a multi-threaded program, the stack is tree-shaped.
What should happen if one of the three parallel threads panics?
I believe the right semantics here is that siblings are cancelled, and then the panic is propagated to the parent.
How to implement cancellation is an open question.
If <em>two</em> children panic, we should propagate a pair of panics.</p>
</section>
<section id="Almost-UnwindSafe">

    <h2>
    <a href="#Almost-UnwindSafe">Almost UnwindSafe </a>
    </h2>
<p>A topic closely related to lock poisoning is unwinding safety &ndash; <code>UnwindSafe</code> and <code>RefUnwindSafe</code> traits.
I want to share an amusing story how this machinery almost, but not quite, saved my bacon.</p>
<p>rust-analyzer implements cancellation via unwinding.
After a user types something and we have new code to process, we set a global flag.
Long-running background tasks like syntax highlighting read this flag and, if it is set, panic with a <code>struct Cancelled</code> payload.
We use <code>resume_unwind</code> and not <code>panic</code> to avoid printing backtrace.
After the stack is unwound, we can start processing new code.</p>
<p>This means that rust-analyzer&rsquo;s data, stored in the <code>Db</code> type, needs to be unwind safe.</p>
<p>One day while I was idly hacking on rust-analyzer during Rust all-hands I&rsquo;ve noticed a weird compilation error, telling me that <code>Db</code> doesn&rsquo;t implement the corresponding trait.
What&rsquo;s worse, removing the <code>target</code> directory fixed the bug.
This was an instance of incorrect incremental compilation.</p>
<p>The problem stemmed from two issues:</p>
<ul>
<li>
<code>UnwindSafe</code> and <code>RefUnwindSafe</code> are auto traits, and inference rules for those are complicated
</li>
<li>
<code>Db</code> type has a curiously recurring template structure
</li>
</ul>
<p>With incremental compilation in the mix, something somewhere went wrong.</p>
<p>The compiler bug was fixed after several months, but, to work around it in the meantime, we&rsquo;ve added a manual <code>impl UnwindSafe for Db</code> which masked the bug.</p>
<p>Couple of months more has passed, and we started integrating chalk into rust-analyzer.
At that time, chalk had it&rsquo;s own layer of caching, in addition to the incremental compilation of rust-analyzer itself.
So we had something like this:</p>

<figure class="code-block">


<pre><code><span class="hl-keyword">struct</span> <span class="hl-title class_">Db</span> {</code>
<code>    solver: parking_lot::Mutex&lt;ChalkSolver&gt;,</code>
<code>    ...</code>
<code>}</code></pre>

</figure>
<p>(We used parking_lot for perf, and to share mutex impl between salsa and rust-analyzer).</p>
<p>Now, one of the differences between <code>std::Mutex</code> and <code>parking_lot::Mutex</code> is lock poisoning.
And that means that <code>std::Mutex</code> is unwind safe (as it just becomes poisoned), while <code>parking_lot::Mutex</code> is not.
Chalk used some <code>RefCell</code>&rsquo;s internally, so it wasn&rsquo;t unwind safe.
So the whole <code>Db</code> stopped being <code>UnwindSafe</code> after addition of chalk.
<em>But</em> because we had that manual <code>impl UnwindSafe for Db</code>, we haven&rsquo;t noticed this.</p>
<p>And that lead to a heisenbug.
If cancellation happened during trait solving, we unwound past <code>ChalkSolver</code>.
And, as didn&rsquo;t have strict exception safety guarantees, that messed up its internal questions.
So the <em>next</em> trait solving query would observe really weird errors like index out of bounds inside chalk.</p>
<p>The solution was to:</p>
<ul>
<li>
remove the manual impl (by that time the underlying compiler bug was fixed).
</li>
<li>
get the <code>Db: !UnwindSafe</code> expected error.
</li>
<li>
replace <code>parking_lot::Mutex</code> with <code>std::Mutex</code> to get unwind-safety.
</li>
<li>
change calls to <code>.lock</code> to propagate cancellation.
</li>
</ul>
<p>The last point is interesting, it means that we need support for recoverable poisoning in this case.
We need to understand that the other thread was cancelled mid-operation (so that chalk&rsquo;s state might be inconsistent).
And we also need to re-raise the panic with a <em>specific</em> payload &mdash; the <code>Cancelled</code> struct.
This is because the situation is not a bug.</p>
<p>Discussion on <a href="https://old.reddit.com/r/rust/comments/kbnphb/blog_post_notes_on_lock_poisoning/">/r/rust</a>.</p>
</section>
</article>
  </main>

  <footer class="site-footer">
    <p>
      <a href="https://github.com/matklad/matklad.github.io/edit/master/src/posts/2020-12-12-notes-on-lock-poisoning.dj">
        <i class="fa fa-edit"></i> fix typo
      </a>

      <a href="/feed.xml">
        <i class="fa fa-rss"></i> rss
      </a>

      <a href="https://github.com/matklad">
        <i class="fa fa-github"></i> matklad
      </a>
    </p>
  </footer>
</body>

</html>
